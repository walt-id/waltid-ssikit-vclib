package id.walt.vclib

import com.beust.klaxon.Klaxon
import com.nimbusds.jwt.JWTClaimsSet
import id.walt.vclib.model.toCredential
import id.walt.vclib.credentials.Europass
import id.walt.vclib.model.VerifiableCredential
import io.kotest.assertions.json.shouldEqualJson
import io.kotest.core.spec.style.StringSpec
import io.kotest.matchers.shouldBe
import java.io.File

class VCConversionTest : StringSpec({

    "1. jwt parser test" {
        val jwt = "eyJraWQiOiJkaWQ6ZWJzaToyMndGN2tVREZUM3RrdTVxdzQ0TGRWdThvMmRKc1U0RkxOSjd6SzRLbmhlbUdLeDUiLCJ0eXAiOiJKV1QiLCJhbGciOiJFUzI1NksifQ.eyJpc3MiOiJkaWQ6ZWJzaToyMndGN2tVREZUM3RrdTVxdzQ0TGRWdThvMmRKc1U0RkxOSjd6SzRLbmhlbUdLeDUiLCJzdWIiOiJkaWQ6a2V5Ono2TWt2Z2hjaGtkdWZ3Y2RZZFBnc3h2YUhQZkU2WjZ3ZDQ0NndUaWp3algxaXFBciIsIm5iZiI6MTYzMTAwMzY2MiwiaWF0IjoxNjMxMDAzNjYyLCJ2YyI6eyJjcmVkZW50aWFsU2NoZW1hIjp7ImlkIjoiaHR0cHM6XC9cL2FwaS5wcmVwcm9kLmVic2kuZXVcL3RydXN0ZWQtc2NoZW1hcy1yZWdpc3RyeVwvdjFcL3NjaGVtYXNcLzB4YmY3OGZjMDhhN2E5ZjI4ZjU0NzlmNThkZWEyNjlkMzY1N2Y1NGYxM2NhMzdkMzgwY2Q0ZTkyMjM3ZmI2OTFkZCIsInR5cGUiOiJKc29uU2NoZW1hVmFsaWRhdG9yMjAxOCJ9LCJjcmVkZW50aWFsU3ViamVjdCI6eyJsZWFybmluZ1NwZWNpZmljYXRpb24iOnsiaXNjZWRmQ29kZSI6WyI3Il0sImVjdHNDcmVkaXRQb2ludHMiOjEyMCwiZXFmTGV2ZWwiOjcsImlkIjoiaHR0cHM6XC9cL2xlYXN0b24uYmNkaXBsb21hLmNvbVwvbGF3LWVjb25vbWljcy1tYW5hZ2VtZW50I0xlYXJuaW5nU3BlY2lmaWNhdGlvbiIsIm5xZkxldmVsIjpbIjciXX0sImlkZW50aWZpZXIiOiIwOTA0MDA4MDg0SCIsImF3YXJkaW5nT3Bwb3J0dW5pdHkiOnsiaWRlbnRpZmllciI6Imh0dHBzOlwvXC9jZXJ0aWZpY2F0ZS1kZW1vLmJjZGlwbG9tYS5jb21cL2NoZWNrXC84N0VEMkYyMjcwRTZDNDE0NTZFOTRCODZCOUQ5MTE1QjRFMzVCQ0NBRDIwMEE0OUI4NDY1OTJDMTRGNzlDODZCVjFGbmJsbHRhME5aVG5Ka1IzbERXbFJtVERsU1JVSkVWRlpJU21ObVl6SmhVVTVzWlVKNVoyRkpTSHBXYm1aWiIsImVuZGVkQXRUaW1lIjoiMjAyMC0wNi0yNlQwMDowMDowMFoiLCJzdGFydGVkQXRUaW1lIjoiMjAxOS0wOS0wMlQwMDowMDowMFoiLCJhd2FyZGluZ0JvZHkiOnsicmVnaXN0cmF0aW9uIjoiMDU5NzA2NUoiLCJpZCI6ImRpZDplYnNpOjIyd0Y3a1VERlQzdGt1NXF3NDRMZFZ1OG8yZEpzVTRGTE5KN3pLNEtuaGVtR0t4NSIsInByZWZlcnJlZE5hbWUiOiJMZWFzdG9uIFVuaXZlcnNpdHkiLCJlaWRhc0xlZ2FsSWRlbnRpZmllciI6IlVua25vd24iLCJob21lcGFnZSI6Imh0dHBzOlwvXC9sZWFzdG9uLmJjZGlwbG9tYS5jb21cLyJ9LCJsb2NhdGlvbiI6IkZSQU5DRSIsImlkIjoiaHR0cHM6XC9cL2xlYXN0b24uYmNkaXBsb21hLmNvbVwvbGF3LWVjb25vbWljcy1tYW5hZ2VtZW50I0F3YXJkaW5nT3Bwb3J0dW5pdHkifSwiZmFtaWx5TmFtZSI6IkRPRSIsImdpdmVuTmFtZXMiOiJKYW5lIiwiZGF0ZU9mQmlydGgiOiIxOTkzLTA0LTA4VDAwOjAwOjAwWiIsImxlYXJuaW5nQWNoaWV2ZW1lbnQiOnsiYWRkaXRpb25hbE5vdGUiOlsiRElTVFJJQlVUSU9OIE1BTkFHRU1FTlQiXSwiZGVzY3JpcHRpb24iOiJNQVJLRVRJTkcgQU5EIFNBTEVTIiwiaWQiOiJodHRwczpcL1wvbGVhc3Rvbi5iY2RpcGxvbWEuY29tXC9sYXctZWNvbm9taWNzLW1hbmFnZW1lbnQjTGVhcm5pbmdBY2hpZXZtZW50IiwidGl0bGUiOiJNQVNURVJTIExBVywgRUNPTk9NSUNTIEFORCBNQU5BR0VNRU5UIn0sImdyYWRpbmdTY2hlbWUiOnsiaWQiOiJodHRwczpcL1wvbGVhc3Rvbi5iY2RpcGxvbWEuY29tXC9sYXctZWNvbm9taWNzLW1hbmFnZW1lbnQjR3JhZGluZ1NjaGVtZSIsInRpdGxlIjoiTG93ZXIgU2Vjb25kLUNsYXNzIEhvbm91cnMifX0sInZhbGlkRnJvbSI6IjIwMjEtMDgtMzFUMDA6MDA6MDBaIiwidHlwZSI6WyJWZXJpZmlhYmxlQ3JlZGVudGlhbCIsIlZlcmlmaWFibGVBdHRlc3RhdGlvbiIsIlZlcmlmaWFibGVEaXBsb21hIl0sIkBjb250ZXh0IjpbImh0dHBzOlwvXC93d3cudzMub3JnXC8yMDE4XC9jcmVkZW50aWFsc1wvdjEiXX19.gtdEFs35FUsRz1PYElN99C4Y9QCYejqN3wNVkpYwKC4U8ACnnaDVP5q1fX007qAtA-f0Dm39iA9ShtQIjn_zHA"
        val cred = jwt.toCredential()
        VerifiableCredential::class.java.isAssignableFrom(cred::class.java) shouldBe true
        cred.jwt shouldBe jwt
        cred.json!! shouldEqualJson "{\"@context\":[\"https://www.w3.org/2018/credentials/v1\"],\"credentialSchema\":{\"id\":\"https://api.preprod.ebsi.eu/trusted-schemas-registry/v1/schemas/0xbf78fc08a7a9f28f5479f58dea269d3657f54f13ca37d380cd4e92237fb691dd\",\"type\":\"JsonSchemaValidator2018\"},\"credentialSubject\":{\"awardingOpportunity\":{\"awardingBody\":{\"eidasLegalIdentifier\":\"Unknown\",\"homepage\":\"https://leaston.bcdiploma.com/\",\"id\":\"did:ebsi:22wF7kUDFT3tku5qw44LdVu8o2dJsU4FLNJ7zK4KnhemGKx5\",\"preferredName\":\"Leaston University\",\"registration\":\"0597065J\"},\"endedAtTime\":\"2020-06-26T00:00:00Z\",\"id\":\"https://leaston.bcdiploma.com/law-economics-management#AwardingOpportunity\",\"identifier\":\"https://certificate-demo.bcdiploma.com/check/87ED2F2270E6C41456E94B86B9D9115B4E35BCCAD200A49B846592C14F79C86BV1Fnbllta0NZTnJkR3lDWlRmTDlSRUJEVFZISmNmYzJhUU5sZUJ5Z2FJSHpWbmZZ\",\"location\":\"FRANCE\",\"startedAtTime\":\"2019-09-02T00:00:00Z\"},\"dateOfBirth\":\"1993-04-08T00:00:00Z\",\"familyName\":\"DOE\",\"givenNames\":\"Jane\",\"gradingScheme\":{\"id\":\"https://leaston.bcdiploma.com/law-economics-management#GradingScheme\",\"title\":\"Lower Second-Class Honours\"},\"id\":\"did:key:z6MkvghchkdufwcdYdPgsxvaHPfE6Z6wd446wTijwjX1iqAr\",\"identifier\":\"0904008084H\",\"learningAchievement\":{\"additionalNote\":[\"DISTRIBUTION MANAGEMENT\"],\"description\":\"MARKETING AND SALES\",\"id\":\"https://leaston.bcdiploma.com/law-economics-management#LearningAchievment\",\"title\":\"MASTERS LAW, ECONOMICS AND MANAGEMENT\"},\"learningSpecification\":{\"ectsCreditPoints\":120,\"eqfLevel\":7,\"id\":\"https://leaston.bcdiploma.com/law-economics-management#LearningSpecification\",\"iscedfCode\":[\"7\"],\"nqfLevel\":[\"7\"]}},\"issued\":\"2021-09-07T08:34:22Z\",\"issuer\":\"did:ebsi:22wF7kUDFT3tku5qw44LdVu8o2dJsU4FLNJ7zK4KnhemGKx5\",\"issuanceDate\":\"2021-08-31T00:00:00Z\",\"validFrom\":\"2021-08-31T00:00:00Z\",\"type\":[\"VerifiableCredential\",\"VerifiableAttestation\",\"VerifiableDiploma\"]}"
    }

    "2. parse and convert vp" {
        val vp = "{\"@context\" : [\"https://www.w3.org/2018/credentials/v1\"], \"id\" : \"id\", \"holder\" : \"did:ebsi:00000004321\", \"verifiableCredential\" : [\"eyJraWQiOiJkaWQ6a2V5Ono2TWtvNDU2OTdrRGI4SnZERWR2QXpBZHM0R1FxUEphWEdEQzg1UkFUQUROdXZndyIsInR5cCI6IkpXVCIsImFsZyI6IkVkRFNBIn0.eyJpc3MiOiJkaWQ6a2V5Ono2TWtvNDU2OTdrRGI4SnZERWR2QXpBZHM0R1FxUEphWEdEQzg1UkFUQUROdXZndyIsInN1YiI6ImRpZDprZXk6ejZNa280NTY5N2tEYjhKdkRFZHZBekFkczRHUXFQSmFYR0RDODVSQVRBRE51dmd3IiwibmJmIjoxNjMxMTE3MzI1LCJpYXQiOjE2MzExMTczMjUsInZjIjp7ImNyZWRlbnRpYWxTY2hlbWEiOnsiaWQiOiJodHRwczpcL1wvYXBpLnByZXByb2QuZWJzaS5ldVwvdHJ1c3RlZC1zY2hlbWFzLXJlZ2lzdHJ5XC92MVwvc2NoZW1hc1wvMHhiZjc4ZmMwOGE3YTlmMjhmNTQ3OWY1OGRlYTI2OWQzNjU3ZjU0ZjEzY2EzN2QzODBjZDRlOTIyMzdmYjY5MWRkIiwidHlwZSI6Ikpzb25TY2hlbWFWYWxpZGF0b3IyMDE4In0sImNyZWRlbnRpYWxTdWJqZWN0Ijp7ImxlYXJuaW5nU3BlY2lmaWNhdGlvbiI6eyJpc2NlZGZDb2RlIjpbIjciXSwiZWN0c0NyZWRpdFBvaW50cyI6MTIwLCJlcWZMZXZlbCI6NywiaWQiOiJodHRwczpcL1wvbGVhc3Rvbi5iY2RpcGxvbWEuY29tXC9sYXctZWNvbm9taWNzLW1hbmFnZW1lbnQjTGVhcm5pbmdTcGVjaWZpY2F0aW9uIiwibnFmTGV2ZWwiOlsiNyJdfSwiaWRlbnRpZmllciI6IjA5MDQwMDgwODRIIiwiYXdhcmRpbmdPcHBvcnR1bml0eSI6eyJpZGVudGlmaWVyIjoiaHR0cHM6XC9cL2NlcnRpZmljYXRlLWRlbW8uYmNkaXBsb21hLmNvbVwvY2hlY2tcLzg3RUQyRjIyNzBFNkM0MTQ1NkU5NEI4NkI5RDkxMTVCNEUzNUJDQ0FEMjAwQTQ5Qjg0NjU5MkMxNEY3OUM4NkJWMUZuYmxsdGEwTlpUbkprUjNsRFdsUm1URGxTUlVKRVZGWklTbU5tWXpKaFVVNXNaVUo1WjJGSlNIcFdibVpaIiwiZW5kZWRBdFRpbWUiOiIyMDIwLTA2LTI2VDAwOjAwOjAwWiIsInN0YXJ0ZWRBdFRpbWUiOiIyMDE5LTA5LTAyVDAwOjAwOjAwWiIsImF3YXJkaW5nQm9keSI6eyJyZWdpc3RyYXRpb24iOiIwNTk3MDY1SiIsImlkIjoiZGlkOmtleTp6Nk1rbzQ1Njk3a0RiOEp2REVkdkF6QWRzNEdRcVBKYVhHREM4NVJBVEFETnV2Z3ciLCJwcmVmZXJyZWROYW1lIjoiTGVhc3RvbiBVbml2ZXJzaXR5IiwiZWlkYXNMZWdhbElkZW50aWZpZXIiOiJVbmtub3duIiwiaG9tZXBhZ2UiOiJodHRwczpcL1wvbGVhc3Rvbi5iY2RpcGxvbWEuY29tXC8ifSwibG9jYXRpb24iOiJGUkFOQ0UiLCJpZCI6Imh0dHBzOlwvXC9sZWFzdG9uLmJjZGlwbG9tYS5jb21cL2xhdy1lY29ub21pY3MtbWFuYWdlbWVudCNBd2FyZGluZ09wcG9ydHVuaXR5In0sImZhbWlseU5hbWUiOiJET0UiLCJnaXZlbk5hbWVzIjoiSmFuZSIsImRhdGVPZkJpcnRoIjoiMTk5My0wNC0wOFQwMDowMDowMFoiLCJsZWFybmluZ0FjaGlldmVtZW50Ijp7ImFkZGl0aW9uYWxOb3RlIjpbIkRJU1RSSUJVVElPTiBNQU5BR0VNRU5UIl0sImRlc2NyaXB0aW9uIjoiTUFSS0VUSU5HIEFORCBTQUxFUyIsImlkIjoiaHR0cHM6XC9cL2xlYXN0b24uYmNkaXBsb21hLmNvbVwvbGF3LWVjb25vbWljcy1tYW5hZ2VtZW50I0xlYXJuaW5nQWNoaWV2bWVudCIsInRpdGxlIjoiTUFTVEVSUyBMQVcsIEVDT05PTUlDUyBBTkQgTUFOQUdFTUVOVCJ9LCJpZCI6ImRpZDplYnNpOjJBRU1BcVhXS1lNdTFKSFBBZ0djZ2E0ZHh1N1RoZ2ZnTjk1VnlKQkpHWmJTSlV0cCIsImdyYWRpbmdTY2hlbWUiOnsiaWQiOiJodHRwczpcL1wvbGVhc3Rvbi5iY2RpcGxvbWEuY29tXC9sYXctZWNvbm9taWNzLW1hbmFnZW1lbnQjR3JhZGluZ1NjaGVtZSIsInRpdGxlIjoiTG93ZXIgU2Vjb25kLUNsYXNzIEhvbm91cnMifX0sImlzc3VhbmNlRGF0ZSI6IjIwMjEtMDgtMzFUMDA6MDA6MDBaIiwiaWQiOiJlZHVjYXRpb24jaGlnaGVyRWR1Y2F0aW9uI2I2NDc5ZTc5LTM2YTktNGM0MS04OTgwLTcwMWZlYWEzZjAyNyIsInZhbGlkRnJvbSI6IjIwMjEtMDgtMzFUMDA6MDA6MDBaIiwidHlwZSI6WyJWZXJpZmlhYmxlQ3JlZGVudGlhbCIsIlZlcmlmaWFibGVBdHRlc3RhdGlvbiIsIlZlcmlmaWFibGVEaXBsb21hIl0sIkBjb250ZXh0IjpbImh0dHBzOlwvXC93d3cudzMub3JnXC8yMDE4XC9jcmVkZW50aWFsc1wvdjEiXSwiaXNzdWVyIjoiZGlkOmVic2k6MkE5Qlo5U1VlNkJhdGFjU3B2czFWNUNkakh2THBRN2JFc2kySmI2TGRIS25ReGFOIn19.n2JSEDA3jAeRHGRareF2ScDoVDQ1K6upbvIgszitRNyYF319H8kuKVq9Dn0IHSVO30VqbWsuvyk0U5-JL1RECw\"], \"type\" : [\"VerifiablePresentation\"]}"
        Klaxon().toJsonString(vp.toCredential().toMap()) shouldEqualJson vp
    }

    "3. Europass jwt claim" {
        val input = File("src/test/resources/serialized/Europass.json").readText()
        val verifiableAttestationJsonLd = input.toCredential() as Europass

        val payload = JWTClaimsSet.Builder()
            .claim("vc", verifiableAttestationJsonLd.toMap()) // TODO reduce payload of VA
            .build().toString()

        val vcClaim = JWTClaimsSet.parse(payload).getClaim("vc") as Map<String, Any>
        val vcClaimJson = VerifiableCredential.klaxon.toJsonString(vcClaim)

        vcClaimJson shouldEqualJson input
        vcClaimJson.toCredential().encode() shouldEqualJson input
    }
})
